#!/usr/bin/env python

import os
import sys
from typing import List, Optional
from pathlib import Path
import subprocess
from subprocess import Popen
# import paella

DEVKA = os.path.realpath(os.path.join(os.path.dirname(__file__), ".."))
CLASSICO = os.path.realpath(os.path.join(os.path.dirname(__file__), "../classico"))

sys.path.insert(0, CLASSICO)
import paella

from paella import Option, Argument

#----------------------------------------------------------------------------------------------

@cli_app
class App:
    def prolog(self):
        return "**Create Docker container with benefits**"

app = App()

@app.command(main=True, extra_args_desc='docker args')
def dvm(
        name: II[Optional[str], Argument(help="Container name", show_default=False)] = None,
        osnick: II[Optional[str], Argument(help='Use image of given osnick (i.e., dvm:OSNICK), default: same as host', show_default=False)] = None,
        
        name1: II[str, Option('-n', '--name', help='Container name', show_default=False, group="Docker")] = None,
        osnick1: II[str, Option('-o', '--osnick', help='Use image of given osnick (i.e., dvm:OSNICK)', show_default=False, group="Docker")] = None,
        daemon: II[bool, Option('-d', '--daemon', help='Run container as daemon', group="Docker")] = False,
        rebuild: II[bool, Option('-r', '--rebuild', help='Rebuild image', group="Docker")] = False,
        local: II[bool, Option('-l', '--local', help='Local context', group="Docker")] = False,

        home: II[bool, Option('-h', '--home', help='Fetch arfiracts from $HOME', group="Devka")] = False,
        classico: II[str, Option('-c', '--classico', help='classico path', show_default=False, group="Devka")] = None,
        devka: II[str, Option('--devka', help='devka path', show_default=False, group="Devka")] = None,
        devka_user: II[str, Option('-u', '--devka-user', help='devka-user path', show_default=False, group="Devka")] = None,
        
        verbose: II[bool, Option("--verbose", "-v", help="Turn on extra logging")] = False,
        nop: II[bool, Option("--nop", "-N", help="No operation")] = False,
        ):

    if osnick is None and osnick1 is not None:
        osnick = osnick1
    if osnick is None:
        os_nick = paella.Platform().osnick
    else:
        os_nick = paella.OSNick(osnick)

    if verbose:
        print("# osnick: " + str(os_nick))

    if rebuild:
        dim = os_nick.docker_image()
        subprocess.call(["make", "-C", f"{DEVKA}/dvm", f"IMAGE_NAME={image}", f"OS={dim}", "FAST=1"])
        exit(0)
    else:
        if name is not None and name1 is not None and name != name1:
            eprint(f"incompatible names: {name} and {name1}")
            exit(1)
        if name is None and name1 is not None:
            name = name1
        if name is None:
            paella.fatal("missing container name")

        if verbose:
            print("# name: " + name)
    
    image = f"dvm:{os_nick}"
    try:
        if not rebuild:
            paella.sh(f"docker image inspect {image}")
    except:
        eprint(f"image {image} does not exist. use option -r to build it.")
        exit(1)

    docker_args = []
    run_args = app.extra_args
    if verbose:
        print(f"# docker args: {run_args}");

    if devka_user:
        user_dir = devka_user
    else:
        user_dir = f"{Path.home()}/.devka-user"
        local = True

    if local:
        docker_args += ['--context', 'local']

    if daemon:
        run_args += ["-d"]

    run_cmd = ["docker"] + docker_args
    run_cmd += ["run", "-it", "--privileged", "--rm",
        "--name", name, "-e", f"DOCKER_NAME={name}",
        "-v", "/v:/v",
        "-v", f"{user_dir}:/root/.devka-user"]
    if devka:
        run_cmd += ["-v", f"{devka}:/root/.devka"]
    if classico:
        run_cmd += ["-v", f"{classico}:/root/.devka/classico"]
    run_cmd += run_args
    run_cmd += [image, "/bin/bash", "-l"]

    if nop:
        print(" ".join(run_cmd))
    else:
        subprocess.call(run_cmd)
        if daemon:
            subprocess.call(["docker", "exec", "-it", name, "/bin/bash", "-l"])

#----------------------------------------------------------------------------------------------

#
#parser.add_argument('--clone', action="store_true", default=False, help='Copy automation infra into container')
#parser.add_argument('-b', '--bare', action="store_true", default=False, help='Run without automation infra')
#

if __name__ == "__main__":
    app()
