#!/usr/bin/env python

import os
import sys
from typing import List, Optional
from pathlib import Path
import subprocess
from subprocess import Popen
import rich
# import paella

DEVKA = os.path.realpath(os.path.join(os.path.dirname(__file__), ".."))
CLASSICO = os.path.realpath(os.path.join(os.path.dirname(__file__), "../classico"))

sys.path.insert(0, CLASSICO)
import paella

from paella import Option, Argument

#----------------------------------------------------------------------------------------------

@cli_app
class App:
    def prolog(self):
        return "Development environment manager"

app = App()

@app.command(help="Pull latest version from git repo")
def update(
        quiet: II[bool, Option('--quiet', '-q', help="Be quiet")] = False,
        verbose: II[bool, Option('--verbose', '-v', help="Be verbose")] = False):
    with paella.cwd(DEVKA):
        if sh("git rev-parse --abbrev-ref HEAD") != "main":
            if not quiet:
                eprint("Devka on branch $branch - not updated")
            exit(1)
        try:
            old_latest = sh("git rev-parse HEAD")
            sh("git diff --quiet")
        except paella.ShError as x:
            eprint("Devka is modified: either commit or revert changes")
            exit(1)
        sh("git pull --quiet --recurse-submodules")
        new_latest = sh("git rev-parse HEAD")
        if new_latest == old_latest and verbose:
            print("No changes")
        if new_latest != old_latest and not quiet:
            print("Devka updated")

@app.command(help="Configuration of user repository")
def user(
        set: II[str, Option(..., metavar="USER", show_default=False, help="Set user repo to github.com/[user]/devito-user")] = None,
        verbose: II[bool, Option('--verbose', '-v', help="Be verbose")] = False):
    pass

if __name__ == "__main__":
    app()
